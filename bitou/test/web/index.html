<html>
  <body>
    <script src="/webui.js"></script>

    <script>
      const createBridge = () => {
        var bridge = null
        const isWebui = () => !!window.webui
        const connect = async () => {
          if (!isWebui()) return Promise.reject(null)
          const webui = window.webui
          if (webui.isConnected()) return Promise.resolve((bridge = webui))
          return new Promise((resolve) => {
            webui.setEventCallback((state) => {
              if (state == webui.event.CONNECTED) {
                bridge = webui
                resolve(webui)
              }
            })
          })
        }

        const request = (name, data = {}) => {
          return new Promise((resolve, reject) => {
            bridge.call(name, JSON.stringify(data)).then((...res) => {
              resolve(...res.map((v) => JSON.parse(v)))
            }, reject)
          })
        }

        return {
          isWebui,
          connect,
          request,
        }
      }
      window.onload = async function () {
        const bridge = createBridge()

        console.log(window)
        console.log(window.webui)
        console.log({ bridge })
        await bridge.connect()
        bridge.request("/stage").then((res) => {
          console.log(res)
        })
        bridge.request("/operation/list").then((res) => {
          console.log(res)
        })
      }
    </script>
  </body>
</html>
